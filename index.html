<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soyfa Food - Customer</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Mobile-First, Responsive, Modern UI */
        :root {
            --primary-color: #ff6347; /* Vibrant Tomato Red/Orange */
            --secondary-color: #555;
            --background-start: #fceabb; /* Light Food Gradient Start */
            --background-end: #f8b500; /* Light Food Gradient End */
            --title-bg-color: transparent; /* Changed to transparent */
            --title-shadow-color: #f0a000; /* Darker shade of yellow for 3D depth */
            --card-background: #ffffff;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            --text-color: #333;
            --step-active-color: #4CAF50;
            --step-inactive-color: #ccc;
            --nav-height: 60px;
            --menu-action-height: 65px; 
            --content-pad: 15px; /* Standard content padding */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; color: var(--text-color); }
        body { 
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%); 
            line-height: 1.6; 
            padding-bottom: var(--nav-height); 
            min-height: 100vh; 
        }
        
        /* FIX START: Removed all fixed header related CSS and body padding-top */
        #app-panel:not(.hidden) body {
            padding-top: 0; 
            padding-bottom: var(--nav-height); 
        }
        /* FIX END */
        
        .hidden { display: none !important; }
        .container { padding-left: var(--content-pad); padding-right: var(--content-pad); max-width: 600px; margin: 0 auto; }
        
        /* FIX: Content Panel Padding */
        .content-panel.container {
            padding-top: var(--content-pad); 
            padding-bottom: var(--content-pad); 
        }

        /* FIX: Menu Scroll Wrapper - REMOVED SCROLLBAR HIDING AND FIXED HEIGHTS */
        #menu-scroll-wrapper {
            /* Now an unrestricted div, allowing page scroll */
            overflow-y: visible; /* Changed from auto/scroll */
            padding-bottom: 0; 
        }
        /* END SCROLL FIX */


        .btn { padding: 12px 15px; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; font-weight: bold; text-align: center; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-small { padding: 6px 10px !important; width: auto !important; font-size: 0.9em !important; margin-top: 5px !important; display: inline-block !important; }
        .btn-primary { background-color: var(--primary-color); color: white; box-shadow: 0 4px 15px rgba(255, 99, 71, 0.4); }
        .btn-primary:hover { background-color: #e05c44; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 99, 71, 0.6); }
        .btn-secondary { background-color: #eee; color: var(--secondary-color); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .btn-secondary:hover { background-color: #ddd; transform: translateY(-1px); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; color: #666; }

        /* Auth Styles */
        #auth-panel { display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
        #auth-image { 
            width: 90%; 
            max-width: 350px; 
            height: 150px; 
            object-fit: cover; 
            border-radius: var(--border-radius); 
            margin-bottom: 20px; 
            box-shadow: var(--shadow); 
        }
        .auth-card { background: var(--card-background); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 90%; max-width: 350px; text-align: center; }
        .auth-card h2 { color: var(--primary-color); margin-bottom: 20px; }
        .auth-card input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .info-link-btn { display: block; width: 100%; padding: 12px 15px; margin-bottom: 8px; border: none; border-radius: var(--border-radius); background-color: var(--card-background); text-align: left; text-decoration: none; font-size: 16px; font-weight: bold; color: var(--secondary-color); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); }

        /* Navigation & Structure */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--card-background); box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { text-align: center; flex-grow: 1; padding: 5px; cursor: pointer; color: #ccc; transition: color 0.3s ease; font-size: 12px; }
        .nav-item.active { color: var(--primary-color); }
        .icon::before { content: "\1F3E0"; display: block; font-size: 20px; margin-bottom: 3px; }
        .icon-orders::before { content: "\1F6CD"; }
        .icon-profile::before { content: "\1F464"; }

        /* 3D Title Design */
        .app-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 32px; 
            color: var(--primary-color);
            text-shadow: 
                2px 2px 0 var(--title-shadow-color), 
                4px 4px 0 #555, 
                6px 6px 8px rgba(0, 0, 0, 0.4); 
            margin-top: 5px; 
            margin-bottom: 15px;
            display: block;
        }
        
        /* Goal 1: Search Bar Styling */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        #restaurant-search {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .search-icon {
            position: absolute;
            top: 50%; 
            right: 15px;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 18px;
            pointer-events: none;
        }

        /* Notification Design and Animation (Non-fixed) */
        .notification-alert {
            background-color: #ffaa00; 
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0; 
            transform: scale(0); 
            animation: pop-and-jiggle-in 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; 
        }
        
        .notification-alert .celebrate-icon {
            margin-right: 10px;
            font-size: 1.2em; 
        }

        .notification-alert.hidden {
            animation: none;
            display: none !important;
        }

        .alert-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
            padding: 0 5px;
            margin-left: 10px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .alert-close-btn:hover { opacity: 1; }

        @keyframes pop-and-jiggle-in {
            0% { opacity: 0; transform: scale(0.5); }
            60% { opacity: 1; transform: scale(1.15); } 
            80% { transform: scale(0.95); } 
            100% { opacity: 1; transform: scale(1); } 
        }
        /* ------------------------------------------------ */
        
        /* NEW: Order Done Modal Styles */
        #order-done-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .order-done-card {
            background: #4CAF50; /* Green success color */
            color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            width: 80%;
            max-width: 300px;
            text-align: center;
            animation: pulse-in 0.5s ease-out;
        }
        .order-done-card .icon {
            font-size: 5em;
            line-height: 1;
            margin-bottom: 10px;
            display: block;
        }
        .order-done-card h3 {
            color: white;
            margin-bottom: 5px;
            font-size: 1.5em;
        }
        .order-done-card p {
            color: #eee;
            margin-bottom: 20px;
        }
        @keyframes pulse-in {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        /* END Order Done Modal Styles */
        
        /* Home View & Components */
        #home-view > .app-title {
             margin-top: 0; 
        }
        #slider-wrapper { overflow: hidden; border-radius: var(--border-radius); margin-bottom: 15px; box-shadow: var(--shadow); }
        #banner-slider { display: flex; width: 300%; transition: transform 0.5s ease-in-out; }
        .banner-image { width: 33.333%; height: 180px; object-fit: cover; flex-shrink: 0; }
        .restaurant-card { background: var(--card-background); padding: 0; margin-bottom: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; overflow: hidden; }
        .restaurant-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }
        .restaurant-card-image { width: 100%; height: 150px; object-fit: cover; border-bottom: 1px solid #f0f0f0; }
        .restaurant-card-details { padding: 15px; }
        .restaurant-card-details h3 { color: var(--primary-color); margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .restaurant-card-offline { background-color: #ffeaea; opacity: 0.7; pointer-events: none; }
        .rating-chip { background-color: #4CAF50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }

        /* Menu View Fixes */
        #menu-actions-fixed {
            position: fixed;
            bottom: var(--nav-height); 
            left: 0;
            right: 0;
            z-index: 999;
            background: var(--card-background); 
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 5px 0;
            height: var(--menu-action-height);
        }
        #menu-actions-fixed .container {
            display: flex;
            gap: 10px; 
            align-items: center;
            padding-top: 0;
            padding-bottom: 0;
        }
        #menu-actions-fixed .btn {
            margin-top: 0; 
            flex-grow: 1; 
            width: auto; 
            padding: 10px 15px; 
        }
        #menu-view {
             padding-bottom: calc(var(--menu-action-height) + var(--content-pad)); /* Ensures scrollable space above fixed menu bar */
        }
        #menu-view .app-title {
             margin-top: 0; 
        }
        #menu-restaurant-image { margin-top: 15px; }
        #menu-scroll-wrapper {
            overflow-y: visible;
        }


        /* Menu Item Styling */
        #menu-restaurant-image { width: 100%; height: 180px; object-fit: cover; border-radius: var(--border-radius); margin-bottom: 15px; box-shadow: var(--shadow); }
        .menu-item { display: flex; background: var(--card-background); border-radius: var(--border-radius); margin-bottom: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); align-items: center; gap: 15px; }
        
        .item-image {
            width: 70px; 
            height: 70px; 
            object-fit: cover;
            border-radius: 8px; 
            flex-shrink: 0; 
        }
        .item-details {
            flex-grow: 1; 
        }
        .item-details h4 {
            font-size: 1.1em;
            margin-bottom: 3px;
            color: var(--text-color);
        }
        .item-details p {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 5px;
        }
        .item-price {
            font-weight: bold;
            color: var(--primary-color);
        }

        .add-to-cart-btn { padding: 8px 12px; background-color: var(--step-active-color); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; flex-shrink: 0; transition: all 0.2s; box-shadow: 0 2px 5px rgba(76, 175, 80, 0.4); }

        /* Cart View */
        #cart-view {
            padding-bottom: calc(var(--nav-height) + var(--content-pad)); 
        }
        #cart-view .app-title {
             margin-top: 0; 
        }
        #cart-view h2 {
             margin-top: 15px; 
        }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cart-item-controls { display: flex; align-items: center; background: #f5f5f5; border-radius: 20px; padding: 2px; }
        .cart-item-controls button { width: 30px; height: 30px; border-radius: 50%; border: none; background: white; font-weight: bold; color: var(--primary-color); cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .checkout-summary { background: #fff; padding: 20px; border-radius: var(--border-radius); margin-top: 20px; box-shadow: var(--shadow); }
        .empty-cart-state { text-align: center; padding: 50px 20px; color: #999; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .empty-cart-icon { font-size: 60px; margin-bottom: 20px; display: block; opacity: 0.5; }

        /* Orders & Tracking */
        #orders-view {
             padding-bottom: calc(var(--nav-height) + var(--content-pad)); 
        }
        #orders-view .app-title {
             margin-top: 0; 
        }
        #orders-view h2 {
             margin-top: 15px; 
        }
        .order-card { background: var(--card-background); padding: 15px; margin-bottom: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .order-status { padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; color: white; }
        .order-status.DELIVERED { background-color: var(--step-active-color); }
        .tracking-bar { display: flex; justify-content: space-between; align-items: center; position: relative; margin: 25px 0; padding: 0 10px; min-height: 50px; }
        .tracking-bar::before, .tracking-bar::after { content: ''; position: absolute; top: 25px; left: 10px; height: 4px; transform: translateY(-50%); }
        .tracking-bar::before { right: 10px; background-color: var(--step-inactive-color); z-index: 1; }
        .tracking-bar::after { left: 10px; background-color: var(--step-active-color); width: var(--progress-width, 0%); transition: width 0.5s ease-in-out; z-index: 2; border-radius: 4px; }
        .tracking-step { display: flex; flex-direction: column; align-items: center; width: 25%; position: relative; z-index: 3; font-size: 0.8em; color: #777; }
        .tracking-icon { width: 30px; height: 30px; border-radius: 50%; background-color: var(--step-inactive-color); color: white; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; box-shadow: 0 0 0 4px var(--card-background); transition: all 0.3s ease; }
        .tracking-step.active .tracking-icon { background-color: var(--step-active-color); transform: scale(1.1); }
        .tracking-step.active { color: var(--text-color); font-weight: 500; }
        
        /* Profile */
        #profile-view {
            padding-bottom: calc(var(--nav-height) + var(--content-pad)); 
        }
        #profile-view .app-title {
             margin-top: 0; 
        }
        #profile-view h2 {
             margin-top: 15px; 
        }
        .profile-card { background: var(--card-background); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .profile-field { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .profile-field-label { font-weight: 500; color: var(--secondary-color); }
        .stars { display: flex; flex-direction: row-reverse; justify-content: flex-end; }


        /* NEW: Rating Modal Styles */
        #rating-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1020;
            backdrop-filter: blur(4px);
        }
        .rating-card {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 300px;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        .rating-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .rating-stars {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            margin-bottom: 20px;
        }
        .rating-stars input[type="radio"] {
            display: none;
        }
        .rating-stars label {
            font-size: 2.5em;
            color: #ccc;
            cursor: pointer;
            padding: 0 4px;
            transition: color 0.2s;
        }
        .rating-stars input[type="radio"]:checked ~ label {
            color: #ffc107; /* Gold color */
        }
        .rating-stars label:hover,
        .rating-stars label:hover ~ label {
            color: #ffdb58; /* Lighter gold on hover */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body onclick="initAudioUnlock()"> 
    <!-- IMPORTANT: Set the src for order-done-sound to the direct file link from your GitHub repo -->
    <audio id="order-done-sound" src="https://audio-previews.elements.envatousercontent.com/files/510236607/preview.mp3" preload="auto"></audio>
    <audio id="click-sound" src="https://raw.githubusercontent.com/Soyab01/SoyfaFoodLadnun/main/preview.mp3" preload="auto"></audio>

    <!-- App Rating Modal (NEW) -->
    <div id="rating-modal" class="hidden">
        <div class="rating-card">
            <h3>Rate Soyfa Food</h3>
            <p>We'd love to hear your feedback!</p>
            <div class="rating-stars">
                <!-- 5-Star input. Clicking 5 stars redirects to Play Store -->
                <input type="radio" id="app-s5" name="app-rating" value="5" onclick="redirectToPlayStore();"/><label for="app-s5" onclick="playClickSound()">★</label>
                <input type="radio" id="app-s4" name="app-rating" value="4" onclick="document.getElementById('rating-modal').classList.add('hidden'); if(auth.currentUser) db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true }); alert('Thank you for your rating!');"/><label for="app-s4" onclick="playClickSound()">★</label>
                <input type="radio" id="app-s3" name="app-rating" value="3" onclick="document.getElementById('rating-modal').classList.add('hidden'); if(auth.currentUser) db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true }); alert('Thank you for your rating!');"/><label for="app-s3" onclick="playClickSound()">★</label>
                <input type="radio" id="app-s2" name="app-rating" value="2" onclick="document.getElementById('rating-modal').classList.add('hidden'); if(auth.currentUser) db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true }); alert('Thank you for your rating!');"/><label for="app-s2" onclick="playClickSound()">★</label>
                <input type="radio" id="app-s1" name="app-rating" value="1" onclick="document.getElementById('rating-modal').classList.add('hidden'); if(auth.currentUser) db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true }); alert('Thank you for your rating!');"/><label for="app-s1" onclick="playClickSound()">★</label>
            </div>
            <p style="font-size: 0.8em; color: #777;">*5-star rating will take you to the Play Store!</p>
            <button class="btn btn-secondary" style="margin-top: 15px;" onclick="document.getElementById('rating-modal').classList.add('hidden'); if(auth.currentUser) db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true }); playClickSound();">Close</button>
        </div>
    </div>
    
    <!-- NEW: Order Done Modal -->
    <div id="order-done-modal" class="hidden">
        <div class="order-done-card">
            <span class="icon">✓</span>
            <h3>Order Placed!</h3>
            <p>Preparing your delicious meal now.</p>
        </div>
    </div>


    <!-- 1. Auth/Login Panel -->
    <div id="auth-panel" class="container">
        <!-- FIX: Updated Image URL for reliability -->
        <img id="auth-image" src="https://cdn.appsrhino.com/new-website-2022/strapi/What_is_the_scope_of_food_delivery_app_development_in_the_next_decade_6e1ff5706a.png" onerror="this.onerror=null;this.src='https://via.placeholder.com/350x150?text=Food+Delivery';" alt="Food Delivery Banner">
        <div class="auth-card" id="auth-main-card">
            <h2 id="auth-title">Sign Up</h2> 
            <input type="email" id="auth-email" placeholder="Email" required>
            <input type="password" id="auth-password" placeholder="Password" required>
            <input type="text" id="auth-name" placeholder="Name" required>
            <input type="text" id="auth-phone" placeholder="Phone" required>
            <input type="text" id="auth-city" placeholder="City" required> 
            <input type="text" id="auth-pincode" placeholder="Pincode" required> 
            <input type="text" id="auth-address" placeholder="Address (Optional)">
            <button class="btn btn-primary" id="auth-action-btn" onclick="playClickSound(); handleAuth();">Sign Up</button>
            <p id="auth-error" style="color: var(--primary-color); margin-top: 15px;" class="hidden"></p>
            <button class="btn btn-secondary" onclick="playClickSound(); toggleAuthMode();">Switch to Login</button>
             <div style="margin-top: 20px; text-align: center;">
                <a href="#" class="info-link" onclick="playClickSound(); showInfoPage('about-page');">About</a> | 
                <a href="#" class="info-link" onclick="playClickSound(); showInfoPage('privacy-page');">Privacy Policy</a> | 
                <a href="#" class="info-link" onclick="playClickSound(); showInfoPage('terms-page');">Terms</a>
            </div>
        </div>
        <!-- Info Page Content -->
        <div id="about-page" class="info-page hidden"><h2 style="color: var(--primary-color);">About Soyfa Food</h2><p>Welcome to Soyfa Food, your local food delivery partner, dedicated to bringing the best meals from your favourite local restaurants right to your doorstep, quickly and reliably. We connect local customers with quality food vendors, ensuring fresh and timely delivery every time.</p><button class="btn btn-secondary" onclick="playClickSound(); showInfoPage('auth-main-card');">← Back</button></div>
        <div id="privacy-page" class="info-page hidden"><h2 style="color: var(--primary-color);">Privacy Policy</h2><p>We respect your privacy. This policy explains how we collect, use, and protect your personal information (Name, Email, Phone, Address, Pincode) solely for the purpose of processing and delivering your food orders and improving our service. We do not share your personal data with third parties for marketing purposes.</p><button class="btn btn-secondary" onclick="playClickSound(); showInfoPage('auth-main-card');">← Back</button></div>
        <div id="terms-page" class="info-page hidden"><h2 style="color: var(--primary-color);">Terms & Conditions</h2><p>By using the Soyfa Food application, you agree to comply with our terms of service, including our order placement and payment policies. All prices are subject to change. The service facilitates the transaction between you and the restaurant/delivery partner. We are not responsible for the food preparation itself.</p><button class="btn btn-secondary" onclick="playClickSound(); showInfoPage('auth-main-card');">← Back</button></div>
         <div id="cancellation-page" class="info-page hidden"><h2 style="color: var(--primary-color);">Cancellation Policy</h2><p>Cancellations are permitted only before the restaurant starts preparing the order (status 'PLACED' or 'ACCEPTED'). Once the order status changes to 'PREPARING' or later, cancellation is not possible, and no refund will be issued. Please contact support immediately for cancellation requests.</p><button class="btn btn-secondary" onclick="playClickSound(); showInfoPage('auth-main-card');">← Back</button></div>
    </div>

    <!-- 2. Main Application Panel -->
    <div id="app-panel" class="hidden"> 
        
        <!-- 2.1 Home View -->
        <div id="home-view" class="content-panel container">
            <!-- Title -->
            <h1 class="app-title">Soyfa Food</h1> 
            <!-- Notification -->
            <p id="notification-banner" class="notification-alert hidden"><span class="celebrate-icon">🎉</span><span id="notification-text"></span><button class="alert-close-btn" onclick="playClickSound(); closeNotification();">×</button></p>
            
            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" id="restaurant-search" placeholder="Search restaurants or cuisine..." onkeyup="filterRestaurants(this.value);">
                <span class="search-icon">🔍</span>
            </div>
            
            <h2 id="user-greeting" style="color: var(--primary-color); margin-bottom: 20px;">Welcome!</h2>
            
            <!-- Banner Slider Wrapper -->
            <div id="slider-wrapper">
                <div id="banner-slider">
                    <img class="banner-image" src="https://b.zmtcdn.com/data/dish_photos/0f7/7c9e90b66dabd5aa5bb51ee96ac6d0f7.jpg" alt="Dish 1">
                    <img class="banner-image" src="https://i.ndtvimg.com/i/2017-08/indian-food_650x400_81501923865.jpg" alt="Dish 2">
                    <img class="banner-image" src="https://b.zmtcdn.com/data/dish_photos/a2e/1bd19d0b97ed99e76bf590573bd43a2e.jpeg" alt="Dish 3">
                </div>
            </div>

            <h2>Approved Restaurants</h2>
            <div id="restaurants-list"><p>Loading restaurants...</p></div>
        </div>

        <!-- 2.2 Menu View -->
        <div id="menu-view" class="content-panel container hidden">
            <!-- Title -->
            <h1 class="app-title">Soyfa Food</h1> 
            <!-- Notification -->
            <p id="notification-banner" class="notification-alert hidden"><span class="celebrate-icon">🎉</span><span id="notification-text"></span><button class="alert-close-btn" onclick="playClickSound(); closeNotification();">×</button></p>
            
            <img id="menu-restaurant-image" src="" alt="Restaurant Image">
            <h2 id="menu-restaurant-name" style="margin-bottom: 5px;">Restaurant Name</h2>
            <p id="menu-restaurant-cuisine" style="margin-bottom: 15px; color: #777;"></p>
            <!-- Scrollable wrapper for menu items - NOW JUST A DIV, PAGE SCROLLS -->
            <div id="menu-items-list"></div>
        </div>

        <!-- Fixed Menu Action Bar -->
        <div id="menu-actions-fixed" class="hidden">
            <div class="container">
                <button class="btn btn-secondary" id="back-to-restaurants-btn" onclick="playClickSound(); showPanel('home-view');">← Back to Restaurants</button>
                <button class="btn btn-primary" id="view-cart-btn" onclick="playClickSound(); showCart();">View Cart (₹<span id="cart-total-display">0.00</span>)</button>
            </div>
        </div>


        <!-- 2.3 Orders View -->
        <div id="orders-view" class="content-panel container hidden">
            <!-- Title -->
            <h1 class="app-title">Soyfa Food</h1> 
            <!-- Notification -->
            <p id="notification-banner" class="notification-alert hidden"><span class="celebrate-icon">🎉</span><span id="notification-text"></span><button class="alert-close-btn" onclick="playClickSound(); closeNotification();">×</button></p>
            
            <h2>My Orders</h2>
            <div id="orders-list"><p>Loading orders...</p></div>
        </div>

        <!-- 2.4 Profile View -->
        <div id="profile-view" class="content-panel container hidden">
            <!-- Title -->
            <h1 class="app-title">Soyfa Food</h1> 
            <!-- Notification -->
            <p id="notification-banner" class="notification-alert hidden"><span class="celebrate-icon">🎉</span><span id="notification-text"></span><button class="alert-close-btn" onclick="playClickSound(); closeNotification();">×</button></p>
            
            <h2>My Profile</h2>
            <div class="profile-card">
                <div id="profile-display-mode">
                    <div class="profile-field"><span class="profile-field-label">Name:</span><span id="display-name">N/A</span></div>
                    <div class="profile-field"><span class="profile-field-label">Email:</span><span id="display-email">N/A</span></div>
                    <div class="profile-field"><span class="profile-field-label">Phone:</span><span id="display-phone">N/A</span></div>
                    <div class="profile-field"><span class="profile-field-label">City:</span><span id="display-city">N/A</span></div>
                    <div class="profile-field"><span class="profile-field-label">Pincode:</span><span id="display-pincode">N/A</span></div>
                    <div class="profile-field" style="border-bottom: none;"><span class="profile-field-label">Address:</span><span id="display-address">N/A</span></div>
                    <button class="btn btn-secondary" onclick="playClickSound(); toggleProfileEditMode(true);">Edit Profile</button>
                </div>
                <div id="profile-edit-form" class="hidden">
                    <input type="text" id="profile-name" placeholder="Your Name" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="email" id="profile-email" disabled style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; background: #eee;">
                    <input type="text" id="profile-phone" placeholder="Phone" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="text" id="profile-city" placeholder="City" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px;"> 
                    <input type="text" id="profile-pincode" placeholder="Pincode" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px;"> 
                    <input type="text" id="profile-address" placeholder="Address" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <button class="btn btn-primary" onclick="playClickSound(); updateProfile();">Save Profile</button>
                    <button class="btn btn-secondary" onclick="playClickSound(); toggleProfileEditMode(false);">Cancel</button>
                </div>
                <div style="margin-top: 30px;">
                    <a href="#" class="info-link-btn" onclick="playClickSound(); document.getElementById('rating-modal').classList.remove('hidden');">Rate App</a> 
                    <a href="#" class="info-link-btn" onclick="playClickSound(); shareApp();">Share App</a> 
                    <a href="#" class="info-link-btn" onclick="playClickSound(); showProfileInfoPage('about-page');">About Us</a> 
                    <a href="#" class="info-link-btn" onclick="playClickSound(); showProfileInfoPage('privacy-page');">Privacy Policy</a> 
                    <a href="#" class="info-link-btn" onclick="playClickSound(); showProfileInfoPage('terms-page');">Terms & Conditions</a> 
                    <a href="#" class="info-link-btn" onclick="playClickSound(); showProfileInfoPage('cancellation-page');">Cancellation Policy</a>
                </div>
                <button class="btn btn-secondary" style="margin-top: 20px;" onclick="playClickSound(); customerLogout();">Logout</button>
            </div>
        </div>

        <!-- NEW FULL SCREEN CART VIEW -->
        <div id="cart-view" class="content-panel container hidden">
            <!-- Title -->
            <h1 class="app-title">Soyfa Food</h1> 
            <!-- Notification -->
            <p id="notification-banner" class="notification-alert hidden"><span class="celebrate-icon">🎉</span><span id="notification-text"></span><button class="alert-close-btn" onclick="playClickSound(); closeNotification();">×</button></p>
            
            <h2 style="color: var(--primary-color);">Your Cart</h2>
            <div id="cart-items-list">
                <!-- Cart items or Empty State will appear here -->
            </div>

            <!-- Checkout Section -->
            <div id="checkout-section" class="hidden">
                <div class="checkout-summary">
                    <div><span>Subtotal:</span> <span>₹<span id="cart-subtotal">0.00</span></span></div>
                    <div><span>Delivery Fee:</span> <span>₹<span id="cart-delivery-fee">50.00</span></span></div>
                    <hr style="margin: 10px 0; border-top: 1px dashed #ddd;">
                    <div style="font-size: 1.2em; font-weight: bold; color: var(--primary-color);">
                        <span>Total to Pay (COD):</span> <span>₹<span id="cart-total">0.00</span></span>
                    </div>
                </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px;">Delivery Details</h3>
                <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow);">
                    <input type="text" id="checkout-name" placeholder="Receiver Name" style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;" required>
                    <input type="text" id="checkout-phone" placeholder="Receiver Phone" style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;" required>
                    <textarea id="checkout-address" placeholder="Full Delivery Address" style="width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; resize: vertical; min-height: 80px;" required></textarea>
                </div>

                <button class="btn btn-primary" id="place-order-btn" style="margin-top: 20px; font-size: 18px; padding: 15px;" onclick="playClickSound(); placeOrder();">CONFIRM ORDER (COD)</button>
            </div>
             <button class="btn btn-secondary" style="margin-top: 20px;" onclick="playClickSound(); goBackFromCart();">← Continue Shopping</button>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-panel="home-view" onclick="playClickSound(); showPanel('home-view');"><span class="icon"></span> Home</div>
            <div class="nav-item" data-panel="orders-view" onclick="playClickSound(); showPanel('orders-view');"><span class="icon icon-orders"></span> Orders</div>
            <div class="nav-item" data-panel="profile-view" onclick="playClickSound(); showPanel('profile-view');"><span class="icon icon-profile"></span> Profile</div>
        </nav>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = { apiKey: "AIzaSyACNrzJgRGKmn8JsRuS_2b7RecPIfahTvQ", authDomain: "singup-aec8c.firebaseapp.com", databaseURL: "https://singup-aec8c-default-rtdb.firebaseio.com", projectId: "singup-aec8c", storageBucket: "singup-aec8c.appspot.com", messagingSenderId: "619246550282", appId: "1:619246550282:web:ab0bb54003d529ca820ef3", measurementId: "G-5KYVBVXQZP" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        // Global State
        let currentRestaurantId = null, customerProfile = {}, cart = [], allRestaurantsData = {};
        const DELIVERY_FEE = 50.00;
        let currentSlide = 0, canPlayAudio = false, isSignUpMode = true; 
        const PLAY_STORE_URL = "https://play.google.com/store/apps/details?id=com.soyfa.soyfaeducation";
        let ratingPopUpTimer = null; // Timer variable for rating pop-up

        // --- NEW: Audio Playback Fix ---
        function playOrderDoneSound() { 
             const sound = document.getElementById('order-done-sound');
             if(sound) {
                 sound.currentTime = 0; // Rewind to start
                 // We use a promise check for reliable playback
                 sound.play().catch(error => {
                     // Note: Playback failed (usually due to uninitiated user interaction)
                     console.error("Order Done Sound Playback failed:", error);
                 }); 
             }
        }
        // --- END Audio Fix ---

        // --- NEW: App Rating & Share Functions ---
        function redirectToPlayStore() {
             // Mark as prompted in DB immediately when 5 star is clicked
             if(auth.currentUser) db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true });
            
            // Check if 5 stars is selected or click came from 5-star
            if(document.getElementById('app-s5').checked) {
                document.getElementById('rating-modal').classList.add('hidden');
                alert("Thank you for your 5-star rating! Redirecting to Play Store...");
                window.open(PLAY_STORE_URL, '_blank'); // Use '_blank' for browser redirect
            }
        }
        
        function shareApp() {
            const shareText = encodeURIComponent("Soyfa Food ऐप बहुत शानदार है! इससे आप आसानी से अपने पसंदीदा रेस्टोरेंट से खाना ऑर्डर कर सकते हैं। इसे आज ही डाउनलोड करें: " + PLAY_STORE_URL);
            
            // Prefer navigator.share if available (more modern)
            if (navigator.share) {
                navigator.share({
                    title: 'Soyfa Food App',
                    text: decodeURIComponent(shareText),
                    url: PLAY_STORE_URL,
                }).catch((error) => console.log('Error sharing', error));
            } else if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Fallback for mobile WhatsApp
                window.open("whatsapp://send?text=" + shareText, '_system');
            } else {
                // Fallback for desktop/web
                alert("WhatsApp Web पर शेयर करने के लिए यह लिंक कॉपी करें:\n\n" + decodeURIComponent(shareText));
            }
        }
        
        function showRatingPopUpOnce() {
            // Check if the user is not yet prompted and is logged in
             if (customerProfile.ratingPrompted !== true && auth.currentUser) {
                
                // Fetch the count of DELIVERED orders
                db.ref('orders')
                    .orderByChild('customerUid').equalTo(auth.currentUser.uid)
                    .once('value', snapshot => {
                        let deliveredCount = 0;
                        snapshot.forEach(childSnapshot => {
                            if (childSnapshot.val().status === 'DELIVERED') {
                                deliveredCount++;
                            }
                        });

                        // Logic: Show pop-up only after the FIRST delivered order (deliveredCount === 1)
                        if (deliveredCount === 1) {
                            
                            // Set a 30 second timer for showing the pop-up
                            ratingPopUpTimer = setTimeout(() => {
                                document.getElementById('rating-modal').classList.remove('hidden');
                                // NOTE: Marking as prompted in DB is done by interaction or close button click
                            }, 30000); // 30 seconds
                        }
                    });
            }
        }
        
        function cancelRatingPopUpTimer() {
             if (ratingPopUpTimer) {
                 clearTimeout(ratingPopUpTimer);
                 ratingPopUpTimer = null;
             }
        }

        function showOrderDoneModal() {
            // 1. Play success sound
            playOrderDoneSound();
            
            // 2. Show the Order Done Modal
            document.getElementById('order-done-modal').classList.remove('hidden');
            
            // 3. Set timer for auto-redirect (2 seconds)
            setTimeout(() => {
                document.getElementById('order-done-modal').classList.add('hidden');
                
                // 4. Redirect to Orders screen
                showPanel('orders-view'); 
            }, 2000); // 2 seconds delay
        }

        // --- END NEW FUNCTIONS ---

        // --- Auth & Init ---
        document.addEventListener('DOMContentLoaded', () => { if(document.getElementById('auth-panel').classList.contains('hidden')) return; toggleAuthMode(true); startAutoSlide(); });
        function initAudioUnlock() { 
             // This function attempts to unlock audio on user interaction
             if (canPlayAudio) return; 
             const o = document.getElementById('order-done-sound');
             const c = document.getElementById('click-sound');
             
             // Try to play both sounds muted/low volume to force unlock
             if(o) { o.volume=0.01; o.play().catch(()=>{}); } 
             if(c) { c.volume=0.01; c.play().catch(()=>{}); } 
             
             setTimeout(()=>{ 
                 // Stop the unlock attempt and reset volumes
                 if(o){o.pause();o.currentTime=0;o.volume=1.0;} 
                 if(c){c.pause();c.currentTime=0;c.volume=0.5;} 
                 canPlayAudio=true; 
             }, 500); 
             // Remove the listener after the first interaction
             document.body.removeEventListener('click', initAudioUnlock); 
        }
        function playClickSound() { 
             const sound = document.getElementById('click-sound');
             if(canPlayAudio && sound) {
                 sound.currentTime = 0;
                 sound.play().catch(()=>{});
             }
        }
        function startAutoSlide() { setInterval(() => { currentSlide = (currentSlide + 1) % 3; document.getElementById('banner-slider').style.transform = `translateX(-${currentSlide * 100 / 3}%)`; }, 5000); }

        function toggleAuthMode(forceSignUp) { isSignUpMode = typeof forceSignUp === 'boolean' ? forceSignUp : !isSignUpMode; document.getElementById('auth-title').textContent = isSignUpMode ? 'Sign Up' : 'Login'; document.getElementById('auth-action-btn').textContent = isSignUpMode ? 'Sign Up' : 'Login'; ['auth-name','auth-phone','auth-city','auth-pincode','auth-address'].forEach(id => document.getElementById(id).classList.toggle('hidden', !isSignUpMode)); document.querySelector('.auth-card button:nth-of-type(2)').textContent = isSignUpMode ? 'Switch to Login' : 'Switch to Sign Up'; document.getElementById('auth-error').classList.add('hidden'); showInfoPage('auth-main-card'); }
        function handleAuth() { const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value, err = document.getElementById('auth-error'); err.classList.add('hidden'); if (isSignUpMode) { const n=document.getElementById('auth-name').value, ph=document.getElementById('auth-phone').value, c=document.getElementById('auth-city').value, pc=document.getElementById('auth-pincode').value; if(!n||!e||!p||!ph||!c||!pc) { err.textContent="Fill all fields."; err.classList.remove('hidden'); return; } auth.createUserWithEmailAndPassword(e,p).then(uc=>{ db.ref(`customers/${uc.user.uid}`).set({name:n,email:e,phone:ph,city:c,pincode:pc,address:document.getElementById('auth-address').value||'N/A',createdAt:new Date().toISOString()}); }).catch(e=>{err.textContent=e.message;err.classList.remove('hidden');}); } else { auth.signInWithEmailAndPassword(e,p).catch(e=>{err.textContent=e.message;err.classList.remove('hidden');}); } }
        function customerLogout() { auth.signOut(); cart = []; cancelRatingPopUpTimer(); } // Cancel timer on logout
        auth.onAuthStateChanged(u => { if(u) { document.getElementById('auth-panel').classList.add('hidden'); document.getElementById('app-panel').classList.remove('hidden'); loadCustomerData(u.uid); loadNotifications(); showPanel('home-view'); } else { document.getElementById('auth-panel').classList.remove('hidden'); document.getElementById('app-panel').classList.add('hidden'); toggleAuthMode(true); } });

        // --- Panel Navigation ---
        function showPanel(panelId) {
            // Cancel timer on every panel change
            cancelRatingPopUpTimer(); 
            document.getElementById('rating-modal').classList.add('hidden'); // Hide modal just in case
            
            document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(panelId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-panel="${panelId}"]`);
            if(activeNav) activeNav.classList.add('active');
            else if (panelId === 'cart-view') {
                 // No bottom nav item for cart, so no active class needed
            }
            
            // Handle fixed menu action bar visibility
            const menuActionsFixed = document.getElementById('menu-actions-fixed');
            if (panelId === 'menu-view') {
                menuActionsFixed.classList.remove('hidden');
            } else {
                menuActionsFixed.classList.add('hidden');
            }
            
            if(panelId === 'orders-view') loadOrders();
            // loadOrders will check for the rating pop-up condition.
            if(panelId === 'home-view') { loadRestaurants(); loadOrders(); } 
        }
        function showInfoPage(pId) { document.querySelectorAll('#auth-panel > div').forEach(e => e.classList.add('hidden')); document.getElementById('auth-image')?.classList.remove('hidden'); document.getElementById(pId).classList.remove('hidden'); if(pId!=='auth-main-card'){ document.getElementById('auth-panel').classList.remove('hidden'); document.getElementById('app-panel').classList.add('hidden'); } }
        function showProfileInfoPage(pId) { showInfoPage(pId); document.querySelector(`#${pId} .btn-secondary`).onclick = () => { playClickSound(); document.getElementById('auth-panel').classList.add('hidden'); document.getElementById('app-panel').classList.remove('hidden'); showPanel('profile-view'); }; }
        function closeNotification() { document.getElementById('notification-banner').classList.add('hidden'); }
        function loadNotifications() { db.ref('admin/notifications').limitToLast(1).on('value', s => { const n = s.val(); if(n) { 
            // UPDATED: Ensure notification is visible and re-animated on new load
            const banner = document.getElementById('notification-banner');
            banner.classList.add('hidden'); // Force hide first to reset animation
            setTimeout(() => {
                document.getElementById('notification-text').textContent = `Announcement: ${Object.values(n).pop().message}`;
                banner.classList.remove('hidden'); // Show with animation
            }, 50);
        } }); }

        // --- Profile ---
        function loadCustomerData(uid) { db.ref(`customers/${uid}`).on('value', s => { customerProfile = s.val() || {}; if(!customerProfile.email && auth.currentUser.email) customerProfile.email = auth.currentUser.email; document.getElementById('user-greeting').textContent = `Welcome, ${customerProfile.name ? customerProfile.name.split(' ')[0] : 'Foodie'}!`; ['name','email','phone','city','pincode','address'].forEach(f => document.getElementById(`display-${f}`).textContent = customerProfile[f] || 'N/A'); ['name','phone'].forEach(f => document.getElementById(`checkout-${f}`).value = customerProfile[f] || ''); document.getElementById('checkout-address').value = customerProfile.address || ''; loadOrders(); loadRestaurants(); }); } // Load orders on data load for rating check
        function toggleProfileEditMode(e) { document.getElementById('profile-display-mode').classList.toggle('hidden', e); document.getElementById('profile-edit-form').classList.toggle('hidden', !e); if(e) ['name','email','phone','city','pincode','address'].forEach(f => document.getElementById(`profile-${f}`).value = customerProfile[f] || ''); }
        function updateProfile() { const u = { name: document.getElementById('profile-name').value.trim(), phone: document.getElementById('profile-phone').value.trim(), city: document.getElementById('profile-city').value.trim(), pincode: document.getElementById('profile-pincode').value.trim(), address: document.getElementById('profile-address').value.trim() || 'N/A' }; if(!u.name||!u.phone||!u.city||!u.pincode) return alert('Fill required fields'); db.ref(`customers/${auth.currentUser.uid}`).update(u).then(() => { alert('Saved!'); toggleProfileEditMode(false); }).catch(e => alert(e.message)); }

        // --- Restaurants & Menu ---
        function loadRestaurants() { const list = document.getElementById('restaurants-list'); if(!customerProfile.pincode || customerProfile.pincode === 'N/A') { list.innerHTML = '<p style="color:red;">Update Pincode in Profile to see restaurants.</p>'; return; } db.ref('restaurants').on('value', s => { allRestaurantsData = s.val() || {}; filterRestaurants(document.getElementById('restaurant-search').value); }); }
        function filterRestaurants(term) {
            const list = document.getElementById('restaurants-list'); list.innerHTML = '';
            let found = false; const search = term.toLowerCase();
            Object.keys(allRestaurantsData).forEach(id => {
                const r = allRestaurantsData[id];
                if (r.approved && r.pincode === customerProfile.pincode && (r.name.toLowerCase().includes(search) || (r.cuisine||'').toLowerCase().includes(search))) {
                    found = true;
                    // FIX: Added onerror to restaurant image as well for robustness
                    list.innerHTML += `<div class="restaurant-card ${r.isOnline===false?'restaurant-card-offline':''}" onclick="${r.isOnline!==false ? `playClickSound(); viewMenu('${id}','${r.name}','${r.cuisine}','${r.imageUrl}');` : ''}"><img src="${r.imageUrl||'https://via.placeholder.com/150'}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=Rest+Err';" class="restaurant-card-image"><div class="restaurant-card-details"><h3><span>${r.name}</span><span class="rating-chip">⭐ ${r.avgRating?r.avgRating.toFixed(1):'N/A'}</span></h3><p>${r.cuisine||'Mixed'} | ${r.address||'N/A'}</p><p style="font-size:0.8em;color:var(--primary-color);">${r.isOnline!==false?'Tap to View Menu':'Currently Offline'}</p></div></div>`;
                }
            });
            if(!found) list.innerHTML = '<p>No restaurants found in your area.</p>';
        }
        function viewMenu(rId, name, cuisine, img) {
            currentRestaurantId = rId; document.getElementById('menu-restaurant-name').textContent = name; document.getElementById('menu-restaurant-cuisine').textContent = cuisine||'Mixed'; document.getElementById('menu-restaurant-image').src = img||'https://via.placeholder.com/180';
            // FIX: Added onerror for Menu header image
            document.getElementById('menu-restaurant-image').onerror = () => { document.getElementById('menu-restaurant-image').src = 'https://via.placeholder.com/180?text=Rest+Err'; document.getElementById('menu-restaurant-image').onerror = null; };
            const list = document.getElementById('menu-items-list'); list.innerHTML = '<p>Loading menu...</p>';
            db.ref(`menus/${rId}`).on('value', s => {
                const m = s.val()||{}; list.innerHTML = '';
                Object.keys(m).forEach(k => { 
                    if(m[k].available!==false) 
                    // FIX: Added class item-image and onerror to menu item image
                    list.innerHTML += `<div class="menu-item"><img src="${m[k].imageUrl||'https://via.placeholder.com/70'}" class="item-image" onerror="this.onerror=null;this.src='https://via.placeholder.com/70?text=Food+Err'"><div class="item-details"><h4>${m[k].name}</h4><p>${m[k].description||''}</p><div class="item-price">₹${m[k].price.toFixed(2)}</div></div><button class="add-to-cart-btn" onclick="playClickSound(); addToCart({id:'${k}',name:'${m[k].name}',price:${m[k].price},restaurantId:'${rId}',restaurantName:'${name}'});">+ ADD</button></div>`; 
                });
                if(list.innerHTML==='') list.innerHTML='<p>No items available.</p>';
            });
            showPanel('menu-view');
        }

        // --- Cart & Checkout ---
        function addToCart(item) {
            if(cart.length>0 && cart[0].restaurantId!==item.restaurantId) { if(!confirm(`Clear cart from ${cart[0].restaurantName} to add from ${item.restaurantName}?`)) return; cart=[]; }
            const ex = cart.find(i=>i.id===item.id); if(ex) ex.quantity++; else cart.push({...item, quantity:1, restaurantName:item.restaurantName});
            updateCartDisplay();
        }
        function updateCartItem(id, change) { const i=cart.find(x=>x.id===id); if(i) { i.quantity+=change; if(i.quantity<=0) cart=cart.filter(x=>x.id!==id); updateCartDisplay(); renderCart(); } }
        function updateCartDisplay() {
            const sub = cart.reduce((s,i)=>s+(i.price*i.quantity),0), total = sub>0?sub+DELIVERY_FEE:0;
            document.getElementById('cart-total-display').textContent = total.toFixed(2);
            document.getElementById('cart-subtotal').textContent = sub.toFixed(2);
            document.getElementById('cart-total').textContent = total.toFixed(2);
        }
        function renderCart() {
            const list = document.getElementById('cart-items-list'); list.innerHTML = '';
            if (cart.length === 0) {
                list.innerHTML = `<div class="empty-cart-state"><span class="empty-cart-icon">🛒</span><h3>Your cart is empty</h3><p>Please select items to order.</p><button class="btn btn-primary" onclick="playClickSound(); showPanel('home-view');" style="margin-top:20px;">Browse Restaurants</button></div>`;
                document.getElementById('checkout-section').classList.add('hidden');
            } else {
                cart.forEach(i => list.innerHTML += `<div class="cart-item"><div class="cart-item-info"><h4>${i.name}</h4><p>₹${i.price.toFixed(2)}</p></div><div class="cart-item-controls"><button onclick="playClickSound(); updateCartItem('${i.id}',-1)">-</button><span>${i.quantity}</span><button onclick="playClickSound(); updateCartItem('${i.id}',1)">+</button></div><div style="font-weight:bold;min-width:60px;text-align:right;">₹${(i.price*i.quantity).toFixed(2)}</div></div>`);
                document.getElementById('checkout-section').classList.remove('hidden');
            }
            updateCartDisplay();
        }
        function showCart() {
            if (!customerProfile.pincode || customerProfile.pincode === 'N/A') { alert('Update Pincode first.'); return showPanel('profile-view'); }
            renderCart();
            showPanel('cart-view');
        }
        function goBackFromCart() {
             // Go back to the last opened panel before cart, or home-view
             const activeNav = document.querySelector('.nav-item.active');
             if (activeNav && activeNav.dataset.panel === 'menu-view') showPanel('menu-view');
             else if (currentRestaurantId) viewMenu(currentRestaurantId, document.getElementById('menu-restaurant-name').textContent, document.getElementById('menu-restaurant-cuisine').textContent, document.getElementById('menu-restaurant-image').src);
             else showPanel('home-view');
        }
        function placeOrder() {
            if(cart.length===0) return alert('Cart is empty');
            const n=document.getElementById('checkout-name').value.trim(), p=document.getElementById('checkout-phone').value.trim(), a=document.getElementById('checkout-address').value.trim();
            if(!n||!p||!a) return alert('Fill delivery details.');
            const sub=cart.reduce((s,i)=>s+(i.price*i.quantity),0), total=sub+DELIVERY_FEE, rId=cart[0].restaurantId;
            const orderRef = db.ref('orders').push();
            orderRef.set({
                orderId: orderRef.key, customerUid: auth.currentUser.uid, restaurantId: rId, deliveryUid: '',
                items: cart.map(i=>({itemId:i.id,name:i.name,price:i.price,quantity:i.quantity})),
                subtotal: sub, deliveryFee: DELIVERY_FEE, totalAmount: total,
                customerName: n, phone: p, address: a, city: customerProfile.city, pincode: customerProfile.pincode,
                paymentMethod: 'COD', status: 'PLACED', createdAt: new Date().toISOString()
            }).then(()=>{
                cart=[];
                // Show done modal and auto-redirect
                showOrderDoneModal();
            }).catch(e=>alert(e.message));
        }

        // --- Orders ---
        function loadOrders() {
            const list = document.getElementById('orders-list'); list.innerHTML = '<p>Loading...</p>';
            db.ref('restaurants').once('value', rs => { const rData = rs.val()||{};
                db.ref('orders').orderByChild('customerUid').equalTo(auth.currentUser.uid).on('value', s => {
                    const oStr = s.val()||{}; list.innerHTML = '';
                    const oArr = Object.values(oStr).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
                    if(oArr.length===0) return list.innerHTML='<p>No orders yet.</p>';
                    
                    let deliveredCount = 0;
                    oArr.forEach(o => {
                         if (o.status === 'DELIVERED') {
                             deliveredCount++;
                         }
                        
                        const step = ['CANCELLED','PLACED','PREPARING','OUT_FOR_DELIVERY','DELIVERED'].indexOf(o.status.replace('ACCEPTED','PLACED').replace('READY_FOR_PICKUP','PREPARING').replace('PICKED_UP','OUT_FOR_DELIVERY'));
                        const prog = step<=0?'0%':step===1?'10%':step===2?'40%':step===3?'70%':'100%';
                        
                        // ADVANCED RATING HTML WITH COMMENT BOX
                        const ratingHTML = (o.status==='DELIVERED' && !o.rating) ? `<div style="margin-top:10px;border-top:1px dashed #eee;padding-top:10px;"><p>Rate:</p><div class="stars"><input type="radio" id="s5-${o.orderId}" name="r-${o.orderId}" value="5"/><label for="s5-${o.orderId}" onclick="playClickSound()">★</label><input type="radio" id="s4-${o.orderId}" name="r-${o.orderId}" value="4"/><label for="s4-${o.orderId}" onclick="playClickSound()">★</label><input type="radio" id="s3-${o.orderId}" name="r-${o.orderId}" value="3"/><label for="s3-${o.orderId}" onclick="playClickSound()">★</label><input type="radio" id="s2-${o.orderId}" name="r-${o.orderId}" value="2"/><label for="s2-${o.orderId}" onclick="playClickSound()">★</label><input type="radio" id="s1-${o.orderId}" name="r-${o.orderId}" value="1"/><label for="s1-${o.orderId}" onclick="playClickSound()">★</label></div><textarea id="comment-${o.orderId}" placeholder="Write a comment (optional)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; margin-top:10px;"></textarea><button class="btn btn-primary btn-small" onclick="submitRating('${o.orderId}')">Submit Rating</button></div>` : (o.rating?`<p style="color:green;font-weight:bold;">You rated: ⭐${o.rating}${o.comment?` ("${o.comment}")`:''}</p>`:'');
                        
                        list.innerHTML += `<div class="order-card"><div class="order-header"><h4>#${o.orderId.substring(0,8)}</h4><span class="order-status ${o.status.replace(/_/g,'')}">${o.status.replace(/_/g,' ')}</span></div><p>From: <strong>${rData[o.restaurantId]?.name||'Restaurant'}</strong> | ₹${o.totalAmount.toFixed(2)}</p>${trackHTML}<p style="font-size:0.9em;color:#777;margin-top:5px;">${o.items.map(i=>`${i.name} x${i.quantity}`).join(', ')}</p>${ratingHTML}</div>`;
                    });
                    
                    // FIX: Check for rating pop-up condition after loading delivered orders
                    if (deliveredCount === 1 && customerProfile.ratingPrompted !== true && document.querySelector('.nav-item.active')?.dataset.panel === 'home-view') {
                        // User has exactly one DELIVERED order and hasn't been prompted yet AND is on the Home Screen.
                        // Set a 30 second timer for showing the pop-up
                        if (ratingPopUpTimer === null) { // Prevent setting multiple timers
                            ratingPopUpTimer = setTimeout(() => {
                                document.getElementById('rating-modal').classList.remove('hidden');
                                // NOTE: Marking as prompted in DB is done by interaction or close button click
                            }, 30000); // 30 seconds
                        }
                    }

                });
            });
        }
        // ADVANCED RATING SUBMISSION FUNCTION
        function submitRating(oId) { 
            const v = document.querySelector(`input[name="r-${oId}"]:checked`)?.value; 
            const c = document.getElementById(`comment-${oId}`)?.value.trim();
            if(!v) return alert('Select stars'); 
            
            const updates = {
                rating: parseInt(v),
                comment: c || null,
                ratedAt: new Date().toISOString()
            };
            
            db.ref(`orders/${oId}`).update(updates).then(()=>{ 
                alert('Thanks for your detailed rating and feedback!'); 
                loadOrders(); 
            }).catch(e => alert(e.message)); 
        }
        
        // Update close button functionality to mark as shown
        document.querySelector('#rating-modal .btn-secondary').onclick = function() {
            document.getElementById('rating-modal').classList.add('hidden');
            // Mark as prompted in DB if the user is logged in
            if (auth.currentUser) {
                db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true });
            }
            playClickSound();
        };

        // Update other star clicks to mark as shown
        document.querySelectorAll('.rating-stars input[name="app-rating"]:not(#app-s5)').forEach(input => {
            input.onclick = function() {
                document.getElementById('rating-modal').classList.add('hidden');
                alert('Thank you for your rating!');
                // Mark as prompted in DB
                 if (auth.currentUser) {
                    db.ref(`customers/${auth.currentUser.uid}`).update({ ratingPrompted: true });
                 }
                playClickSound();
            }
        });
    </script>
</body>
</html>
